#!/bin/bash
# https://github.com/sammtcbn/advutil
# capability , just for south-bound
# Written by sammtcbn 2019.11.5
ME=$(basename $0)
MQTTIP=localhost
HANDLER="OPCUAClient"

USAGE_STR="$(cat <<EOF
Usage: ${ME} [OPTION]...

OPTIONS
  -i <MQTT_IP>
      assign MQTT Broker ip, default is ${MQTTIP}

  -a <HANDLER>
      default is ${HANDLER}

  -h  display this help and exit

EOF
)"

function usage()
{
    echo "$USAGE_STR"
    exit 0
}

while getopts "a:i:h" opt; do
    case $opt in
    a)
       HANDLER=$OPTARG
       ;;
    h)
       usage
       ;;
    i)
       MQTTIP=$OPTARG
       ;;
    esac
done

TOPIC="/cagent/admin/${HANDLER}/agentactionreq"
TS=$(date +%s)000

DESC="this is description"
VERSION="1.0.0"

PAYLOAD="$(cat <<-EOF
{
  "susiCommData": {
    "infoSpec": {
      "${HANDLER}": {
        "info": {
          "bn": "info",
          "e": [
            {
              "n": "type",
              "sv": "Protocol",
              "asm": "r"
            },
            {
              "n": "name",
              "sv": "${HANDLER}",
              "asm": "r"
            },
            {
              "n": "description",
              "sv": "${DESC}",
              "asm": "r"
            },
            {
              "n": "version",
              "sv": "${VERSION}",
              "asm": "r"
            }
          ]
        },
        "OPCUA-0": {
          "bn": "OPCUA-0",
          "Server": {
            "bn": "Server",
            "e": [
              {
                "n": "Name",
                "sv": "ESVM-OPCUASERVER",
                "asm": "r"
              },
              {
                "n": "endpointUrl",
                "sv": "opc.tcp://172.22.12.248:62547",
                "asm": "r"
              },
              {
                "n": "Connection",
                "bv": true,
                "asm": "r"
              }
            ]
          },
          "NodeId": {
            "bn": "NodeId",
            "e": [
              {
                "n": "ns=2;s=1:CC2001?Input2",
                "v": 0,
                "asm": "rw",
                "ex": {
                  "quality": 0
                }
              },
              {
                "n": "ns=2;s=1:CC2001?Output",
                "v": 0,
                "asm": "r",
                "ex": {
                  "quality": 0
                }
              },
              {
                "n": "ns=2;s=1:CC1001?Output",
                "v": 0,
                "asm": "r",
                "ex": {
                  "quality": 0
                }
              }
            ]
          }
        }
      }
    },
    "commCmd": 2052,
    "requestID": 2001,
    "agentID": "${HANDLER}",
    "handlerName": "general",
    "sendTS": ${TS}
  }
}
EOF
)"


mosquitto_pub -h ${MQTTIP} -t ${TOPIC} -d -m "${PAYLOAD}"
if [ $? != 0 ]; then
    usage
fi
