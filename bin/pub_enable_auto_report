#!/bin/bash
# https://github.com/sammtcbn/advutil
# Written by sammtcbn 2019.4.25
function usage()
{
    echo "Usage: $0 [SERVER_IP] [INTERVAL]"
    echo "    SERVER_IP: assign MQTT Broker ip, default is localhost,"
    echo "               or you can use a test broker test.mosquitto.org"
    echo "    INTERVAL: assign auto report interval (second)"
    echo "              default value is 10"
    exit 0
}

SERVER=localhost
INTERVAL=10
#TOPIC="/cagent/admin/ODBC_Handler/agentcallbackreq"
TOPIC="/cagent/admin/OPCUAClient/agentcallbackreq"

if [ ! -z "${1}" ]; then
    SERVER=${1}
fi

if [ ! -z "${2}" ]; then
    INTERVAL=${2}
fi

PAYLOAD="$(cat <<-EOF
{
  "susiCommData": {
    "commCmd": 2053,
    "requestItems": {
      "All": {}
    },
    "autoUploadIntervalSec": ${INTERVAL},
    "handlerName": "general"
  }
}

EOF
)"


mosquitto_pub -h ${SERVER} -t ${TOPIC} -d -m "${PAYLOAD}"
if [ $? != 0 ]; then
    usage
fi
